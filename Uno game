<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>420 UNO Online ‚Äî Smokey Edition</title>
<link href="https://fonts.googleapis.com/css2?family=Bungee+Shade&family=Permanent+Marker&family=Righteous&family=Nunito:wght@400;600;700;800;900&family=Rubik+Glitch&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
<style>
/* ===== ROOT VARIABLES ===== */
:root {
  --bg-deep: #0b0514;
  --bg-room: #120a22;
  --bg-card: #1a0e30;
  --bg-surface: #1f1338;
  --text-primary: #e8d5ff;
  --text-secondary: #b494d9;
  --text-muted: #6e4a99;
  --neon-purple: #b44aff;
  --neon-lime: #7aff3a;
  --neon-amber: #ffb833;
  --neon-teal: #00e5c8;
  --neon-pink: #ff3a8c;
  --neon-gold: #ffd700;
  --card-red: #ff2a2a;
  --card-blue: #2a7aff;
  --card-green: #2aff5a;
  --card-yellow: #ffe02a;
  --smoke-purple: rgba(120, 40, 180, 0.08);
  --smoke-teal: rgba(0, 180, 160, 0.06);
  --glow-purple: 0 0 30px rgba(180, 74, 255, 0.4);
  --glow-lime: 0 0 30px rgba(122, 255, 58, 0.4);
  --glow-amber: 0 0 30px rgba(255, 184, 51, 0.4);
}
html:not(.dark) {
  --bg-deep: #f5f0fa;
  --bg-room: #ede4f7;
  --bg-card: #ffffff;
  --bg-surface: #f0e8f8;
  --text-primary: #2a1845;
  --text-secondary: #5a3a80;
  --text-muted: #8a6aaa;
  --smoke-purple: rgba(120, 40, 180, 0.04);
  --smoke-teal: rgba(0, 180, 160, 0.03);
}
* { margin: 0; padding: 0; box-sizing: border-box; }
body {
  font-family: 'Nunito', sans-serif;
  background: var(--bg-deep);
  color: var(--text-primary);
  min-height: 100vh;
  overflow-x: hidden;
}

/* ===== IMMERSIVE BACKGROUND ===== */
.world-bg {
  position: fixed; inset: 0; z-index: 0; pointer-events: none;
  background:
    radial-gradient(ellipse at 30% 20%, rgba(120, 40, 180, 0.15) 0%, transparent 50%),
    radial-gradient(ellipse at 70% 80%, rgba(0, 180, 160, 0.12) 0%, transparent 50%),
    radial-gradient(ellipse at 50% 50%, rgba(255, 184, 51, 0.06) 0%, transparent 60%),
    var(--bg-deep);
}
/* God rays */
.god-rays {
  position: fixed; inset: 0; z-index: 0; pointer-events: none; overflow: hidden;
}
.god-ray {
  position: absolute; width: 3px; background: linear-gradient(180deg, rgba(255,215,0,0.12) 0%, transparent 100%);
  transform-origin: top center; animation: rayFloat 8s ease-in-out infinite;
}
@keyframes rayFloat {
  0%, 100% { opacity: 0.3; transform: rotate(-2deg) scaleY(1); }
  50% { opacity: 0.7; transform: rotate(2deg) scaleY(1.2); }
}
/* Smoke clouds */
.smoke-layer { position: fixed; inset: 0; z-index: 1; pointer-events: none; overflow: hidden; }
.smoke-cloud {
  position: absolute; border-radius: 50%;
  animation: smokeSwirl linear infinite;
  filter: blur(40px);
}
@keyframes smokeSwirl {
  0% { transform: translate(0, 100vh) scale(0.3) rotate(0deg); opacity: 0; }
  15% { opacity: 0.08; }
  85% { opacity: 0.06; }
  100% { transform: translate(50px, -20vh) scale(3) rotate(360deg); opacity: 0; }
}
/* Ash/ember particles */
.ember-layer { position: fixed; inset: 0; z-index: 2; pointer-events: none; overflow: hidden; }
.ember {
  position: absolute; width: 3px; height: 3px; border-radius: 50%;
  animation: emberFloat linear infinite;
}
@keyframes emberFloat {
  0% { transform: translateY(110vh) scale(1); opacity: 0; }
  10% { opacity: 1; }
  90% { opacity: 0.6; }
  100% { transform: translateY(-10vh) translateX(30px) scale(0.3); opacity: 0; }
}
/* Bokeh */
.bokeh-layer { position: fixed; inset: 0; z-index: 1; pointer-events: none; overflow: hidden; }
.bokeh {
  position: absolute; border-radius: 50%; opacity: 0.08;
  animation: bokehPulse 6s ease-in-out infinite;
}
@keyframes bokehPulse {
  0%, 100% { transform: scale(1); opacity: 0.06; }
  50% { transform: scale(1.3); opacity: 0.12; }
}

/* ===== SCREENS ===== */
.app-wrap { position: relative; z-index: 10; min-height: 100vh; display: flex; flex-direction: column; align-items: center; }
.screen { display: none; width: 100%; max-width: 960px; padding: 12px 16px; }
.screen.active { display: flex; flex-direction: column; align-items: center; }

/* ===== LOGO ===== */
.logo-section { text-align: center; margin: 30px 0 10px; position: relative; }
.logo-smoke-ring {
  position: absolute; top: -20px; left: 50%; transform: translateX(-50%);
  width: 200px; height: 200px; border-radius: 50%;
  background: radial-gradient(circle, rgba(180,74,255,0.1) 0%, transparent 70%);
  animation: logoGlow 3s ease-in-out infinite alternate;
  pointer-events: none;
}
@keyframes logoGlow {
  from { transform: translateX(-50%) scale(1); opacity: 0.6; }
  to { transform: translateX(-50%) scale(1.3); opacity: 1; }
}
.logo-420 {
  font-family: 'Rubik Glitch', cursive;
  font-size: clamp(1.8rem, 5vw, 2.6rem);
  color: var(--neon-lime);
  text-shadow: 0 0 20px rgba(122,255,58,0.6), 0 0 60px rgba(122,255,58,0.3);
  letter-spacing: 4px;
}
.logo-uno {
  font-family: 'Bungee Shade', cursive;
  font-size: clamp(3.5rem, 10vw, 6rem);
  background: linear-gradient(135deg, var(--neon-purple), var(--neon-pink), var(--neon-amber), var(--neon-lime));
  background-size: 300% 300%;
  -webkit-background-clip: text; -webkit-text-fill-color: transparent;
  background-clip: text;
  animation: logoShift 4s ease-in-out infinite;
  filter: drop-shadow(0 0 30px rgba(180,74,255,0.5));
  line-height: 1;
}
@keyframes logoShift {
  0%, 100% { background-position: 0% 50%; }
  50% { background-position: 100% 50%; }
}
.logo-tagline {
  font-family: 'Permanent Marker', cursive;
  font-size: clamp(0.8rem, 2.5vw, 1.1rem);
  color: var(--neon-teal);
  text-shadow: 0 0 15px rgba(0,229,200,0.5);
  letter-spacing: 8px; margin-top: 4px;
}
.logo-embers { font-size: 1.6rem; margin: 6px 0; opacity: 0.8; }

/* ===== BUTTONS ===== */
.btn {
  padding: 16px 28px; border: none; border-radius: 16px; font-family: 'Nunito', sans-serif;
  font-size: 16px; font-weight: 800; cursor: pointer; transition: all 0.3s ease;
  display: flex; align-items: center; justify-content: center; gap: 10px;
  position: relative; overflow: hidden; text-transform: uppercase; letter-spacing: 1px;
}
.btn::before {
  content: ''; position: absolute; inset: 0;
  background: linear-gradient(135deg, rgba(255,255,255,0.1) 0%, transparent 50%);
  pointer-events: none;
}
.btn-blaze {
  background: linear-gradient(135deg, #7aff3a, #3abf1a);
  color: #0a2200; box-shadow: 0 4px 25px rgba(122,255,58,0.4);
}
.btn-blaze:hover { transform: translateY(-3px); box-shadow: 0 8px 40px rgba(122,255,58,0.6); }
.btn-purp {
  background: linear-gradient(135deg, var(--neon-purple), #8a2be2);
  color: #fff; box-shadow: 0 4px 25px rgba(180,74,255,0.35);
}
.btn-purp:hover { transform: translateY(-3px); box-shadow: 0 8px 40px rgba(180,74,255,0.6); }
.btn-gold {
  background: linear-gradient(135deg, var(--neon-amber), #e6a200);
  color: #1a0e00; box-shadow: 0 4px 25px rgba(255,184,51,0.35);
}
.btn-gold:hover { transform: translateY(-3px); box-shadow: 0 8px 40px rgba(255,184,51,0.6); }
.btn-teal {
  background: linear-gradient(135deg, var(--neon-teal), #00b39e);
  color: #001a15; box-shadow: 0 4px 25px rgba(0,229,200,0.35);
}
.btn-teal:hover { transform: translateY(-3px); box-shadow: 0 8px 40px rgba(0,229,200,0.6); }
.btn-ghost {
  background: rgba(255,255,255,0.06); color: var(--text-secondary);
  border: 2px solid rgba(180,74,255,0.25);
}
.btn-ghost:hover { border-color: var(--neon-purple); background: rgba(180,74,255,0.1); transform: translateY(-2px); }
.btn-sm { padding: 10px 18px; font-size: 13px; border-radius: 12px; }
.btn-danger { background: linear-gradient(135deg, #ff2a2a, #cc0000); color: #fff; }
.menu-buttons { display: flex; flex-direction: column; gap: 14px; width: 100%; max-width: 400px; margin-top: 24px; }

/* ===== PANELS ===== */
.panel {
  background: linear-gradient(145deg, var(--bg-card), var(--bg-surface));
  border-radius: 24px; padding: 28px;
  border: 1px solid rgba(180,74,255,0.15);
  box-shadow: 0 8px 40px rgba(0,0,0,0.3), inset 0 1px 0 rgba(255,255,255,0.05);
  width: 100%; max-width: 520px;
  backdrop-filter: blur(10px);
}
.panel h2 {
  font-family: 'Permanent Marker', cursive; font-size: 1.5rem;
  background: linear-gradient(135deg, var(--neon-lime), var(--neon-teal));
  -webkit-background-clip: text; -webkit-text-fill-color: transparent;
  background-clip: text; margin-bottom: 20px; text-align: center;
}
.input-group { margin-bottom: 14px; }
.input-group label {
  display: block; font-size: 13px; font-weight: 800;
  color: var(--text-secondary); margin-bottom: 5px; text-transform: uppercase; letter-spacing: 1px;
}
.input-field {
  width: 100%; padding: 14px 16px; border-radius: 14px;
  border: 2px solid rgba(180,74,255,0.2); background: rgba(0,0,0,0.3);
  color: var(--text-primary); font-family: 'Nunito', sans-serif;
  font-size: 16px; transition: all 0.3s; outline: none;
}
.input-field:focus { border-color: var(--neon-purple); box-shadow: 0 0 20px rgba(180,74,255,0.2); }
.settings-row {
  display: flex; align-items: center; gap: 12px; margin: 10px 0;
}
.settings-row label { font-weight: 700; color: var(--text-secondary); font-size: 14px; }
.settings-row select {
  padding: 10px 14px; border-radius: 12px; background: rgba(0,0,0,0.3);
  color: var(--text-primary); border: 2px solid rgba(180,74,255,0.2);
  font-family: 'Nunito', sans-serif; font-size: 15px; outline: none;
}
.back-btn { align-self: flex-start; margin-bottom: 12px; }

/* ===== ROOM CODE ===== */
.room-code-box {
  background: rgba(0,0,0,0.4); border-radius: 20px; padding: 20px;
  text-align: center; margin: 16px 0;
  border: 2px dashed rgba(122,255,58,0.4);
  position: relative; overflow: hidden;
}
.room-code-box::before {
  content: ''; position: absolute; inset: 0;
  background: radial-gradient(circle at center, rgba(122,255,58,0.05) 0%, transparent 70%);
}
.room-code-box .code-label {
  font-size: 11px; color: var(--text-muted); letter-spacing: 3px; text-transform: uppercase;
}
.room-code-box .code-value {
  font-family: 'Rubik Glitch', cursive; font-size: 2.5rem;
  color: var(--neon-lime); letter-spacing: 8px;
  text-shadow: 0 0 20px rgba(122,255,58,0.6);
}
.invite-row { display: flex; gap: 10px; margin: 12px 0; }
.invite-row .btn { flex: 1; }
.copy-msg { color: var(--neon-lime); font-size: 12px; font-weight: 700; margin-top: 4px; min-height: 18px; text-align: center; }
.player-list { list-style: none; margin: 14px 0; }
.player-list li {
  padding: 12px 16px; border-radius: 14px; margin-bottom: 8px;
  background: rgba(0,0,0,0.25); display: flex; align-items: center; gap: 12px;
  font-weight: 700; color: var(--text-primary);
  border: 1px solid rgba(180,74,255,0.1);
}
.player-list li.host { border-left: 4px solid var(--neon-gold); }
.player-list li .p-avatar { font-size: 24px; }

/* ===== GAME HEADER ===== */
.game-hud {
  display: flex; justify-content: space-between; align-items: center;
  width: 100%; padding: 6px 0; margin-bottom: 6px;
}
.hud-color { display: flex; align-items: center; gap: 8px; }
.color-orb {
  width: 22px; height: 22px; border-radius: 50%;
  border: 3px solid rgba(255,255,255,0.3);
  box-shadow: 0 0 15px currentColor;
  transition: all 0.4s;
}
.hud-turn {
  font-family: 'Permanent Marker', cursive; font-size: 1rem;
  color: var(--neon-amber);
  text-shadow: 0 0 15px rgba(255,184,51,0.5);
}
.hud-dir {
  font-size: 1.4rem; color: var(--neon-teal);
  transition: transform 0.5s;
  text-shadow: 0 0 10px rgba(0,229,200,0.5);
}
.hud-dir.rev { transform: scaleX(-1); }

/* ===== OPPONENTS ===== */
.opp-row { display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; width: 100%; margin-bottom: 10px; }
.opp-card {
  background: linear-gradient(145deg, rgba(26,14,48,0.9), rgba(18,10,34,0.9));
  border-radius: 18px; padding: 10px 14px; text-align: center;
  border: 2px solid transparent; transition: all 0.4s; min-width: 110px;
  position: relative; overflow: hidden;
}
.opp-card::before {
  content: ''; position: absolute; inset: 0;
  background: radial-gradient(circle at 50% 0%, rgba(180,74,255,0.08) 0%, transparent 60%);
  pointer-events: none;
}
.opp-card.active { border-color: var(--neon-lime); box-shadow: 0 0 25px rgba(122,255,58,0.3); }
.opp-avatar { font-size: 2rem; margin-bottom: 2px; position: relative; z-index: 1; }
.opp-name { font-weight: 800; font-size: 11px; color: var(--neon-purple); letter-spacing: 0.5px; text-transform: uppercase; }
.opp-hand-display { font-size: 18px; margin: 4px 0; letter-spacing: -2px; }
.opp-count { font-size: 11px; color: var(--text-muted); font-weight: 700; }
.opp-uno-badge {
  background: linear-gradient(135deg, #ff2a2a, #ff6b3a);
  color: #fff; font-size: 9px; font-weight: 900; padding: 2px 8px;
  border-radius: 8px; display: inline-block; margin-top: 4px;
  animation: unoPulse 0.5s ease-in-out infinite alternate;
  text-transform: uppercase; letter-spacing: 1px;
}
@keyframes unoPulse { from { transform: scale(1); } to { transform: scale(1.2); } }

/* ===== PLAY AREA ‚Äî TABLE ===== */
.table-area {
  position: relative; width: 100%; max-width: 500px;
  aspect-ratio: 2.2/1; margin: 8px auto;
  display: flex; align-items: center; justify-content: center;
  background: radial-gradient(ellipse at center, rgba(60,30,10,0.4) 0%, rgba(20,10,30,0.6) 60%, transparent 100%);
  border-radius: 50%; gap: 30px;
}
.table-area::before {
  content: ''; position: absolute; inset: 10px;
  border-radius: 50%; border: 2px solid rgba(180,74,255,0.08);
  pointer-events: none;
}
.pile {
  width: 90px; height: 135px; border-radius: 14px;
  display: flex; align-items: center; justify-content: center;
  flex-direction: column; cursor: pointer; transition: all 0.3s;
  position: relative;
}
.draw-pile {
  background: linear-gradient(145deg, #1a0e30, #0d0520);
  border: 3px solid rgba(122,255,58,0.4);
  box-shadow: 0 0 30px rgba(122,255,58,0.15), inset 0 0 20px rgba(122,255,58,0.05);
}
.draw-pile:hover { transform: scale(1.06); box-shadow: 0 0 50px rgba(122,255,58,0.3); }
.draw-pile .pile-icon { font-size: 2rem; }
.draw-pile .pile-text {
  font-family: 'Permanent Marker', cursive; font-size: 10px;
  color: var(--neon-lime); letter-spacing: 2px; margin-top: 4px;
}
.discard-pile {
  border: 3px solid rgba(180,74,255,0.3);
  box-shadow: 0 0 30px rgba(180,74,255,0.15);
  overflow: visible;
}
.pile-tag {
  position: absolute; bottom: -20px; font-size: 10px;
  color: var(--text-muted); font-weight: 800; letter-spacing: 2px;
  text-transform: uppercase; white-space: nowrap;
}
.event-msg {
  font-family: 'Permanent Marker', cursive; color: var(--neon-amber);
  font-size: 1rem; text-align: center; min-height: 24px; margin: 4px 0;
  text-shadow: 0 0 15px rgba(255,184,51,0.5);
}

/* ===== CANNABIS UNO CARDS ===== */
.uno-card {
  width: 76px; height: 114px; border-radius: 12px; position: relative;
  display: flex; align-items: center; justify-content: center; flex-direction: column;
  font-family: 'Righteous', cursive; color: #fff; cursor: pointer;
  transition: all 0.25s ease; flex-shrink: 0;
  box-shadow: 0 4px 15px rgba(0,0,0,0.5);
  overflow: hidden;
}
/* Leaf pattern overlay */
.uno-card::before {
  content: 'üçÉ'; position: absolute; font-size: 60px; opacity: 0.08;
  transform: rotate(-30deg); pointer-events: none; z-index: 0;
}
/* Inner ellipse */
.uno-card::after {
  content: ''; position: absolute; width: 55px; height: 80px;
  border-radius: 50%; border: 3px solid rgba(255,255,255,0.2);
  transform: rotate(-15deg); pointer-events: none; z-index: 0;
}
.uno-card .card-val {
  position: relative; z-index: 1; font-size: 1.3rem; line-height: 1;
  text-shadow: 0 2px 8px rgba(0,0,0,0.5);
}
.uno-card .card-motif {
  position: relative; z-index: 1; font-size: 0.7rem; margin-top: 2px;
  opacity: 0.9;
}
.uno-card .corner { position: absolute; font-size: 0.5rem; z-index: 1; }
.uno-card .corner-tl { top: 5px; left: 6px; }
.uno-card .corner-br { bottom: 5px; right: 6px; transform: rotate(180deg); }

/* Card colors */
.c-red { background: linear-gradient(145deg, #ff2a2a, #b81c1c); border: 3px solid rgba(255,100,100,0.4); }
.c-blue { background: linear-gradient(145deg, #2a7aff, #1a4fcc); border: 3px solid rgba(100,150,255,0.4); }
.c-green { background: linear-gradient(145deg, #1aad4a, #0e7a30); border: 3px solid rgba(80,255,120,0.4); }
.c-yellow { background: linear-gradient(145deg, #f0c800, #c8a000); color: #2a1800; border: 3px solid rgba(255,220,80,0.4); }
.c-wild {
  background: conic-gradient(from 45deg, #ff2a2a, #2a7aff, #1aad4a, #f0c800, #ff2a2a);
  border: 3px solid rgba(255,215,0,0.5);
  animation: wildSpin 6s linear infinite;
}
@keyframes wildSpin { from { filter: hue-rotate(0deg); } to { filter: hue-rotate(360deg); } }
.c-wild .card-val { text-shadow: 0 0 15px rgba(255,215,0,0.8), 0 2px 8px rgba(0,0,0,0.5); }

/* Card states */
.uno-card.playable:hover {
  transform: translateY(-22px) scale(1.12);
  box-shadow: 0 12px 40px rgba(122,255,58,0.4), 0 0 20px rgba(122,255,58,0.2);
  z-index: 20;
}
.uno-card.dimmed { opacity: 0.4; cursor: not-allowed; }
.uno-card.dealt { animation: dealIn 0.35s ease-out both; }
@keyframes dealIn {
  from { transform: translateY(-80px) rotate(-15deg) scale(0.5); opacity: 0; }
  to { transform: translateY(0) rotate(0) scale(1); opacity: 1; }
}

/* ===== HAND ===== */
.hand-section { width: 100%; margin-top: 10px; padding-bottom: 16px; }
.hand-header {
  display: flex; align-items: center; gap: 8px; margin-bottom: 6px;
}
.hand-header .hand-icon { font-size: 20px; }
.hand-header .hand-name { font-family: 'Righteous', cursive; font-size: 0.95rem; color: var(--text-secondary); }
.hand-header .hand-count { font-size: 12px; color: var(--text-muted); font-weight: 700; }
.hand-scroll {
  display: flex; overflow-x: auto; padding: 14px 4px 22px;
  scroll-behavior: smooth; -webkit-overflow-scrolling: touch;
  scrollbar-width: thin; scrollbar-color: rgba(180,74,255,0.3) transparent;
}
.hand-scroll::-webkit-scrollbar { height: 4px; }
.hand-scroll::-webkit-scrollbar-thumb { background: rgba(180,74,255,0.3); border-radius: 4px; }
.hand-scroll .uno-card { margin-right: -10px; }
.hand-scroll .uno-card:last-child { margin-right: 0; }

/* ===== ACTION BAR ===== */
.action-bar { display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; margin: 6px 0; }

/* ===== UNO BUTTON ===== */
.uno-fab {
  position: fixed; bottom: 90px; right: 16px; z-index: 60;
  width: 80px; height: 80px; border-radius: 50%;
  background: linear-gradient(135deg, var(--neon-lime), #3abf1a);
  border: 4px solid rgba(255,255,255,0.3);
  display: none; align-items: center; justify-content: center;
  cursor: pointer; font-family: 'Permanent Marker', cursive;
  font-size: 1rem; color: #0a2200;
  box-shadow: 0 0 40px rgba(122,255,58,0.6), 0 0 80px rgba(122,255,58,0.3);
  animation: unoFabPulse 0.8s ease-in-out infinite alternate;
  flex-direction: column; line-height: 1;
}
.uno-fab.show { display: flex; }
.uno-fab .fab-leaf { font-size: 1.6rem; }
.uno-fab .fab-text { font-size: 0.7rem; font-weight: 900; letter-spacing: 2px; }
@keyframes unoFabPulse {
  from { transform: scale(1); box-shadow: 0 0 40px rgba(122,255,58,0.6); }
  to { transform: scale(1.12); box-shadow: 0 0 70px rgba(122,255,58,0.9); }
}

/* ===== MODALS ===== */
.modal-bg {
  position: fixed; inset: 0; background: rgba(0,0,0,0.75);
  display: none; align-items: center; justify-content: center;
  z-index: 100; backdrop-filter: blur(6px);
}
.modal-bg.open { display: flex; }
.modal {
  background: linear-gradient(145deg, var(--bg-card), var(--bg-surface));
  border-radius: 24px; padding: 32px; max-width: 380px; width: 92%;
  text-align: center; border: 2px solid rgba(180,74,255,0.2);
  box-shadow: 0 20px 60px rgba(0,0,0,0.5), 0 0 40px rgba(180,74,255,0.15);
  animation: modalIn 0.3s ease-out;
}
@keyframes modalIn { from { transform: scale(0.85) translateY(20px); opacity: 0; } to { transform: scale(1) translateY(0); opacity: 1; } }
.modal h3 {
  font-family: 'Permanent Marker', cursive; font-size: 1.4rem;
  color: var(--neon-lime); margin-bottom: 20px;
  text-shadow: 0 0 15px rgba(122,255,58,0.4);
}
.color-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
.color-btn {
  padding: 18px; border-radius: 16px; border: 3px solid transparent;
  cursor: pointer; font-weight: 900; font-size: 14px; color: #fff;
  transition: all 0.2s; text-transform: uppercase; letter-spacing: 1px;
}
.color-btn:hover { transform: scale(1.08); border-color: #fff; box-shadow: 0 0 25px currentColor; }
.cb-red { background: linear-gradient(135deg, #ff2a2a, #b81c1c); }
.cb-blue { background: linear-gradient(135deg, #2a7aff, #1a4fcc); }
.cb-green { background: linear-gradient(135deg, #1aad4a, #0e7a30); }
.cb-yellow { background: linear-gradient(135deg, #f0c800, #c8a000); color: #2a1800; }

/* Game Over */
.go-content h2 {
  font-family: 'Bungee Shade', cursive; font-size: 1.8rem;
  color: var(--neon-gold); margin-bottom: 8px;
  text-shadow: 0 0 25px rgba(255,215,0,0.5);
}
.go-content p { color: var(--text-secondary); margin-bottom: 18px; font-size: 1rem; }
.go-trophy { font-size: 3.5rem; margin-bottom: 10px; }

/* ===== TOASTS ===== */
.toast-zone { position: fixed; top: 16px; right: 16px; z-index: 200; display: flex; flex-direction: column; gap: 8px; }
.toast-item {
  background: linear-gradient(145deg, var(--bg-card), var(--bg-surface));
  border: 1px solid rgba(180,74,255,0.2);
  border-radius: 14px; padding: 12px 20px; font-weight: 700; font-size: 13px;
  color: var(--text-primary); box-shadow: 0 4px 20px rgba(0,0,0,0.4);
  animation: toastSlide 0.3s ease-out, toastFade 0.3s ease-in 2.2s forwards;
  max-width: 280px;
}
@keyframes toastSlide { from { transform: translateX(80px); opacity: 0; } }
@keyframes toastFade { to { opacity: 0; transform: translateY(-8px); } }

/* ===== CHAT BONG ===== */
.chat-bong {
  position: fixed; bottom: 16px; left: 16px; z-index: 50;
  width: 50px; height: 50px; border-radius: 50%;
  background: linear-gradient(135deg, var(--neon-purple), #6b2fa0);
  border: 3px solid rgba(255,255,255,0.2);
  display: none; align-items: center; justify-content: center;
  cursor: pointer; font-size: 1.4rem;
  box-shadow: 0 4px 20px rgba(180,74,255,0.4);
  transition: all 0.3s;
}
.chat-bong.show { display: flex; }
.chat-bong:hover { transform: scale(1.1); }
.chat-panel {
  position: fixed; bottom: 80px; left: 16px; z-index: 55;
  width: 260px; max-height: 300px;
  background: linear-gradient(145deg, rgba(26,14,48,0.95), rgba(18,10,34,0.95));
  border-radius: 20px 20px 20px 4px;
  border: 2px solid rgba(180,74,255,0.2);
  box-shadow: 0 8px 40px rgba(0,0,0,0.5);
  display: none; flex-direction: column; overflow: hidden;
  backdrop-filter: blur(10px);
}
.chat-panel.open { display: flex; }
.chat-panel .chat-head {
  padding: 10px 14px; font-family: 'Permanent Marker', cursive;
  font-size: 0.85rem; color: var(--neon-purple);
  border-bottom: 1px solid rgba(180,74,255,0.15);
  display: flex; align-items: center; gap: 6px;
}
.chat-panel .chat-msgs {
  flex: 1; overflow-y: auto; padding: 10px; font-size: 12px;
  color: var(--text-secondary); max-height: 200px;
}
.chat-panel .chat-msgs .cmsg { margin-bottom: 6px; }
.chat-panel .chat-msgs .cmsg b { color: var(--neon-lime); }
.chat-input-row {
  display: flex; border-top: 1px solid rgba(180,74,255,0.15);
}
.chat-input-row input {
  flex: 1; padding: 10px 12px; background: transparent; border: none;
  color: var(--text-primary); font-family: 'Nunito', sans-serif; font-size: 14px; outline: none;
}
.chat-input-row button {
  padding: 10px 14px; background: var(--neon-purple); border: none;
  color: #fff; cursor: pointer; font-weight: 800;
}

/* ===== SCORE BLUNTS ===== */
.score-bar {
  display: flex; align-items: center; gap: 8px; margin: 4px 0;
  font-size: 12px; color: var(--text-muted); font-weight: 700;
}
.score-blunt { font-size: 16px; }

/* ===== RULES ===== */
.rules-content {
  line-height: 1.9; font-size: 14px; color: var(--text-secondary);
}
.rules-content strong { color: var(--neon-lime); }
.rules-content .rule-card {
  display: inline-flex; align-items: center; gap: 6px;
  background: rgba(0,0,0,0.3); padding: 4px 10px; border-radius: 8px;
  margin: 2px 0; font-weight: 700;
}

/* ===== RESPONSIVE ===== */
@media (max-width: 600px) {
  .table-area { gap: 20px; }
  .pile { width: 72px; height: 108px; }
  .uno-card { width: 62px; height: 93px; font-size: 0.9rem; }
  .uno-card .card-val { font-size: 1.1rem; }
  .hand-scroll .uno-card { margin-right: -14px; }
  .opp-card { min-width: 85px; padding: 8px 10px; }
  .opp-avatar { font-size: 1.5rem; }
  .chat-panel { width: 220px; }
  .panel { padding: 20px; }
}
</style>
</head>
<body>

<!-- ===== ATMOSPHERIC LAYERS ===== -->
<div class="world-bg"></div>
<div class="god-rays" id="godRays"></div>
<div class="smoke-layer" id="smokeLayer"></div>
<div class="ember-layer" id="emberLayer"></div>
<div class="bokeh-layer" id="bokehLayer"></div>

<!-- ===== TOASTS ===== -->
<div class="toast-zone" id="toastZone"></div>

<!-- ===== UNO FAB ===== -->
<button class="uno-fab" id="unoFab" onclick="callUno()">
  <span class="fab-leaf">üçÉ</span>
  <span class="fab-text">UNO!</span>
</button>

<!-- ===== CHAT BONG ===== -->
<div class="chat-bong" id="chatBong" onclick="toggleChat()">üí¨</div>
<div class="chat-panel" id="chatPanel">
  <div class="chat-head">ü´ß Bong Chat</div>
  <div class="chat-msgs" id="chatMsgs"></div>
  <div class="chat-input-row">
    <input id="chatInput" placeholder="Say something..." maxlength="100" onkeydown="if(event.key==='Enter')sendChat()">
    <button onclick="sendChat()">üí®</button>
  </div>
</div>

<!-- ===== COLOR MODAL ===== -->
<div class="modal-bg" id="colorModal">
  <div class="modal">
    <h3>üçÉ Pick Your Strain Color üçÉ</h3>
    <div class="color-grid">
      <div class="color-btn cb-red" onclick="pickColor('red')">üî¥ Red Haze</div>
      <div class="color-btn cb-blue" onclick="pickColor('blue')">üîµ Blue Dream</div>
      <div class="color-btn cb-green" onclick="pickColor('green')">üü¢ OG Kush</div>
      <div class="color-btn cb-yellow" onclick="pickColor('yellow')">üü° Lemon Haze</div>
    </div>
  </div>
</div>

<!-- ===== GAME OVER MODAL ===== -->
<div class="modal-bg" id="goModal">
  <div class="modal go-content">
    <div class="go-trophy">üèÜüçÉüí®</div>
    <h2 id="goTitle">You Win!</h2>
    <p id="goSub">Rolled up the competition üí®</p>
    <div style="display:flex;gap:10px;justify-content:center;margin-top:14px;">
      <button class="btn btn-blaze btn-sm" onclick="startGame()">Run It Back üî•</button>
      <button class="btn btn-ghost btn-sm" onclick="goMenu()">Menu</button>
    </div>
  </div>
</div>

<!-- ===== APP ===== -->
<div class="app-wrap">

  <!-- MENU -->
  <div class="screen active" id="scr-menu">
    <div class="logo-section">
      <div class="logo-smoke-ring"></div>
      <div class="logo-420">‚ú¶ 420 ‚ú¶</div>
      <div class="logo-uno">UNO</div>
      <div class="logo-tagline">ONLINE</div>
      <div class="logo-embers">üçÉüí®üî•üí®üçÉ</div>
    </div>
    <div class="menu-buttons">
      <button class="btn btn-blaze" onclick="goScreen('setup')"><i class="fas fa-fire"></i> Quick Sesh</button>
      <button class="btn btn-gold" onclick="goScreen('create-room')"><i class="fas fa-users"></i> Create Private Room</button>
      <button class="btn btn-purp" onclick="goScreen('join-room')"><i class="fas fa-door-open"></i> Join Room</button>
      <button class="btn btn-ghost" onclick="goScreen('rules')"><i class="fas fa-scroll"></i> How to Play</button>
    </div>
    <p style="margin-top:30px;font-size:11px;color:var(--text-muted);text-align:center;letter-spacing:2px;">
      PUFF PUFF PASS... THE CARDS üåø
    </p>
  </div>

  <!-- SETUP -->
  <div class="screen" id="scr-setup">
    <button class="btn btn-sm btn-ghost back-btn" onclick="goScreen('menu')"><i class="fas fa-arrow-left"></i> Back</button>
    <div class="panel">
      <h2>üî• Quick Sesh Setup</h2>
      <div class="input-group">
        <label>Stoner Tag</label>
        <input class="input-field" id="inpName" placeholder="@HighAsHeck420" maxlength="20" value="@PuffMaster">
      </div>
      <div class="settings-row">
        <label>Opponents:</label>
        <select id="selOpps">
          <option value="1">1 Stoner</option>
          <option value="2" selected>2 Stoners</option>
          <option value="3">3 Stoners</option>
        </select>
      </div>
      <div class="settings-row">
        <label>Vibe Level:</label>
        <select id="selDiff">
          <option value="easy">Mellow üåø</option>
          <option value="medium" selected>Lifted üí®</option>
          <option value="hard">Blazed üî•</option>
        </select>
      </div>
      <button class="btn btn-blaze" style="width:100%;margin-top:18px;" onclick="startGame()">
        <i class="fas fa-cannabis"></i> Light It Up
      </button>
    </div>
  </div>

  <!-- CREATE ROOM -->
  <div class="screen" id="scr-create-room">
    <button class="btn btn-sm btn-ghost back-btn" onclick="goScreen('menu')"><i class="fas fa-arrow-left"></i> Back</button>
    <div class="panel">
      <h2>üè† Create Private Sesh</h2>
      <div class="input-group">
        <label>Your Name</label>
        <input class="input-field" id="inpHost" placeholder="@YourTag" maxlength="20" value="@Host420">
      </div>
      <div class="input-group">
        <label>Room Name</label>
        <input class="input-field" id="inpRoomName" placeholder="Chill Den üçÉ" maxlength="28">
      </div>
      <div class="settings-row">
        <label>Max Players:</label>
        <select id="selMaxP">
          <option value="2">2</option>
          <option value="3">3</option>
          <option value="4" selected>4</option>
        </select>
      </div>
      <button class="btn btn-gold" style="width:100%;margin-top:14px;" onclick="createRoom()">
        <i class="fas fa-cannabis"></i> Create Room
      </button>
    </div>
  </div>

  <!-- ROOM LOBBY -->
  <div class="screen" id="scr-lobby">
    <button class="btn btn-sm btn-ghost back-btn" onclick="goScreen('menu')"><i class="fas fa-arrow-left"></i> Leave</button>
    <div class="panel">
      <h2 id="lobbyTitle">üçÉ Chill Den</h2>
      <div class="room-code-box">
        <div class="code-label">ROOM CODE</div>
        <div class="code-value" id="lobbyCode">------</div>
      </div>
      <div class="invite-row">
        <button class="btn btn-sm btn-ghost" onclick="copyCode()"><i class="fas fa-copy"></i> Copy</button>
        <button class="btn btn-sm btn-purp" onclick="shareInvite()"><i class="fas fa-share-alt"></i> Invite</button>
      </div>
      <div class="copy-msg" id="copyMsg"></div>
      <div style="font-size:12px;color:var(--text-muted);margin:8px 0;text-transform:uppercase;letter-spacing:1px;">Players</div>
      <ul class="player-list" id="lobbyList"></ul>
      <button class="btn btn-blaze" style="width:100%;margin-top:14px;" onclick="launchRoomGame()">
        <i class="fas fa-fire"></i> Start Game
      </button>
      <p style="font-size:11px;color:var(--text-muted);margin-top:8px;text-align:center;">Bots fill empty seats ü§ñüí®</p>
    </div>
  </div>

  <!-- JOIN ROOM -->
  <div class="screen" id="scr-join-room">
    <button class="btn btn-sm btn-ghost back-btn" onclick="goScreen('menu')"><i class="fas fa-arrow-left"></i> Back</button>
    <div class="panel">
      <h2>üö™ Join the Sesh</h2>
      <div class="input-group">
        <label>Your Name</label>
        <input class="input-field" id="inpJoinName" placeholder="@YourTag" maxlength="20" value="@ChillVibes">
      </div>
      <div class="input-group">
        <label>Room Code</label>
        <input class="input-field" id="inpJoinCode" placeholder="ABC420" maxlength="6"
          style="font-family:'Rubik Glitch',cursive;font-size:1.8rem;letter-spacing:8px;text-align:center;text-transform:uppercase;">
      </div>
      <button class="btn btn-purp" style="width:100%;margin-top:16px;" onclick="joinRoom()">
        <i class="fas fa-door-open"></i> Join Sesh
      </button>
    </div>
  </div>

  <!-- RULES -->
  <div class="screen" id="scr-rules">
    <button class="btn btn-sm btn-ghost back-btn" onclick="goScreen('menu')"><i class="fas fa-arrow-left"></i> Back</button>
    <div class="panel" style="max-width:620px;">
      <h2>üìñ The Sacred Scroll of 420 UNO</h2>
      <div class="rules-content">
        <p><strong>üéØ Mission:</strong> Be the first to blaze through all your cards.</p><br>
        <p><strong>üÉè The Basics:</strong></p>
        <ul style="padding-left:20px;margin:8px 0;">
          <li>Match the discard by <strong>color</strong> or <strong>value</strong></li>
          <li>Can't play? Hit the draw pile üçÉ</li>
          <li>If you draw a playable card, you can drop it. Otherwise, pass.</li>
        </ul><br>
        <p><strong>üåÄ Special Strains:</strong></p>
        <ul style="padding-left:20px;margin:8px 0;">
          <li><span class="rule-card">üö´ Puff & Pass (Skip)</span> ‚Äî Next player loses turn</li>
          <li><span class="rule-card">üîÑ Boomerang Joint (Reverse)</span> ‚Äî Flips play direction</li>
          <li><span class="rule-card">üö¨üö¨ Double Pre-Roll (+2)</span> ‚Äî Next draws 2 & skips</li>
          <li><span class="rule-card">üåà Golden Nugget (Wild)</span> ‚Äî Choose any color</li>
          <li><span class="rule-card">üå¨Ô∏è BLAZE +4 (Wild Draw 4)</span> ‚Äî Choose color + next draws 4</li>
        </ul><br>
        <p><strong>üçÉ UNO Call:</strong> Smash the green leaf button when down to 1 card! Forget = draw 2 penalty üíÄ</p>
      </div>
    </div>
  </div>

  <!-- GAME -->
  <div class="screen" id="scr-game">
    <div class="game-hud">
      <div class="hud-color">
        <div class="color-orb" id="hudOrb"></div>
        <span id="hudColorName" style="font-size:12px;font-weight:800;color:var(--text-muted);text-transform:uppercase;letter-spacing:1px;">‚Äî</span>
      </div>
      <div class="hud-turn" id="hudTurn">üî• Your Turn</div>
      <div class="hud-dir" id="hudDir"><i class="fas fa-arrow-right"></i></div>
    </div>
    <div class="opp-row" id="oppRow"></div>
    <div class="event-msg" id="eventMsg"></div>
    <div class="table-area">
      <div class="pile draw-pile" id="drawPile" onclick="drawCard()">
        <span class="pile-icon">üçÉ</span>
        <span class="pile-text">DRAW</span>
        <span class="pile-tag">DRAW PILE</span>
      </div>
      <div class="pile discard-pile" id="discardPile">
        <span class="pile-tag">DISCARD</span>
      </div>
    </div>
    <div class="action-bar">
      <button class="btn btn-sm btn-ghost" id="passBtn" onclick="passTurn()" style="display:none;">
        <i class="fas fa-forward"></i> Pass Turn
      </button>
    </div>
    <div class="hand-section">
      <div class="hand-header">
        <span class="hand-icon">üñêÔ∏è</span>
        <span class="hand-name" id="handName">Your Hand</span>
        <span class="hand-count" id="handCount">(7)</span>
      </div>
      <div class="hand-scroll" id="handScroll"></div>
    </div>
  </div>

</div>

<script>
/* ============================================
   420 UNO ONLINE ‚Äî PSYCHEDELIC SMOKEY EDITION
   ============================================ */

// Dark mode
if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
  document.documentElement.classList.add('dark');
}
window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', e => {
  document.documentElement.classList.toggle('dark', e.matches);
});

// ===== ATMOSPHERIC PARTICLES =====
(function initAtmosphere() {
  // Smoke clouds
  const smokeLayer = document.getElementById('smokeLayer');
  const smokeColors = ['rgba(120,40,180,0.06)', 'rgba(0,180,160,0.05)', 'rgba(255,184,51,0.04)', 'rgba(122,255,58,0.03)'];
  for (let i = 0; i < 14; i++) {
    const c = document.createElement('div');
    c.className = 'smoke-cloud';
    const size = 120 + Math.random() * 300;
    c.style.width = size + 'px';
    c.style.height = size + 'px';
    c.style.left = Math.random() * 100 + '%';
    c.style.background = 'radial-gradient(circle, ' + smokeColors[i % smokeColors.length] + ' 0%, transparent 70%)';
    c.style.animationDuration = (15 + Math.random() * 25) + 's';
    c.style.animationDelay = -(Math.random() * 30) + 's';
    smokeLayer.appendChild(c);
  }
  // Embers
  const emberLayer = document.getElementById('emberLayer');
  const emberColors = ['#ffb833', '#ff6b3a', '#ff3a8c', '#ffd700', '#7aff3a'];
  for (let i = 0; i < 25; i++) {
    const e = document.createElement('div');
    e.className = 'ember';
    e.style.left = Math.random() * 100 + '%';
    e.style.background = emberColors[i % emberColors.length];
    e.style.boxShadow = '0 0 6px ' + emberColors[i % emberColors.length];
    e.style.animationDuration = (8 + Math.random() * 15) + 's';
    e.style.animationDelay = -(Math.random() * 20) + 's';
    emberLayer.appendChild(e);
  }
  // God rays
  const rayLayer = document.getElementById('godRays');
  for (let i = 0; i < 6; i++) {
    const r = document.createElement('div');
    r.className = 'god-ray';
    r.style.left = (15 + Math.random() * 70) + '%';
    r.style.top = '0';
    r.style.height = (40 + Math.random() * 40) + '%';
    r.style.animationDelay = -(Math.random() * 8) + 's';
    r.style.animationDuration = (6 + Math.random() * 6) + 's';
    rayLayer.appendChild(r);
  }
  // Bokeh
  const bokehLayer = document.getElementById('bokehLayer');
  const bokehColors = ['rgba(180,74,255,0.08)', 'rgba(122,255,58,0.06)', 'rgba(255,184,51,0.07)', 'rgba(0,229,200,0.06)'];
  for (let i = 0; i < 12; i++) {
    const b = document.createElement('div');
    b.className = 'bokeh';
    const sz = 40 + Math.random() * 100;
    b.style.width = sz + 'px';
    b.style.height = sz + 'px';
    b.style.left = Math.random() * 100 + '%';
    b.style.top = Math.random() * 100 + '%';
    b.style.background = bokehColors[i % bokehColors.length];
    b.style.animationDelay = -(Math.random() * 6) + 's';
    b.style.animationDuration = (4 + Math.random() * 6) + 's';
    bokehLayer.appendChild(b);
  }
})();

// ===== NAVIGATION =====
function goScreen(id) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  const el = document.getElementById('scr-' + id);
  if (el) el.classList.add('active');
  if (id !== 'game') {
    document.getElementById('unoFab').classList.remove('show');
    document.getElementById('chatBong').classList.remove('show');
    document.getElementById('chatPanel').classList.remove('open');
    document.getElementById('goModal').classList.remove('open');
  } else {
    document.getElementById('chatBong').classList.add('show');
  }
}
function goMenu() {
  document.getElementById('goModal').classList.remove('open');
  goScreen('menu');
}

// ===== TOASTS =====
function toast(msg) {
  const zone = document.getElementById('toastZone');
  const t = document.createElement('div');
  t.className = 'toast-item';
  t.textContent = msg;
  zone.appendChild(t);
  setTimeout(() => { if (t.parentNode) t.remove(); }, 2600);
}

// ===== CHAT =====
let chatOpen = false;
function toggleChat() {
  chatOpen = !chatOpen;
  document.getElementById('chatPanel').classList.toggle('open', chatOpen);
}
function sendChat() {
  const inp = document.getElementById('chatInput');
  const msg = inp.value.trim();
  if (!msg) return;
  addChatMsg('You', msg);
  inp.value = '';
  // Bot reply
  setTimeout(() => {
    const replies = [
      'Nice play fam üí®', 'Bro that was cold ü•∂', 'Pass the cards homie üçÉ',
      'Yooo UNO already?! üò§', 'This sesh is fire üî•', 'Chill vibes only üåø',
      'Bruh üíÄ', 'No cap that was smooth', 'Keep it rolling üö¨'
    ];
    if (game && game.players.length > 1) {
      const bot = game.players[1 + Math.floor(Math.random() * (game.players.length - 1))];
      addChatMsg(bot.name, replies[Math.floor(Math.random() * replies.length)]);
    }
  }, 1000 + Math.random() * 2000);
}
function addChatMsg(who, text) {
  const msgs = document.getElementById('chatMsgs');
  const d = document.createElement('div');
  d.className = 'cmsg';
  d.innerHTML = '<b>' + escHtml(who) + ':</b> ' + escHtml(text);
  msgs.appendChild(d);
  msgs.scrollTop = msgs.scrollHeight;
}

// ===== GAME STATE =====
const COLORS = ['red','blue','green','yellow'];
const VALS = ['0','1','2','3','4','5','6','7','8','9','skip','reverse','draw2'];
const CARD_MOTIFS = {
  '0': 'ü´ß', '1': 'üö¨', '2': 'üö¨üö¨', '3': 'üåøüåøüåø', '4': 'üí®4Ô∏è‚É£', '5': 'üçÉ5Ô∏è‚É£',
  '6': 'üî•6Ô∏è‚É£', '7': 'üåø7Ô∏è‚É£', '8': 'üí®8Ô∏è‚É£', '9': 'üçÉ9Ô∏è‚É£',
  'skip': 'üö´', 'reverse': 'üîÑ', 'draw2': 'üö¨üö¨',
  'wild': 'üåà', 'wild4': 'üå¨Ô∏è'
};
const CARD_LABELS = {
  skip: 'PUFF\n&PASS', reverse: 'üîÑ', draw2: '+2', wild: 'üåà', wild4: '+4'
};
const STONERS = [
  {name:'@HighAsHeck420', avatar:'üò∂‚Äçüå´Ô∏è'},
  {name:'@PuffPuffChill', avatar:'üßñ'},
  {name:'@SnoopJoint', avatar:'üêï'},
  {name:'@CheechBlaze', avatar:'üåø'},
  {name:'@ChongCloud', avatar:'üí®'},
  {name:'@MarleyVibes', avatar:'üéµ'},
  {name:'@KushQueen', avatar:'üëë'},
];

let game = null;

function makeDeck() {
  const d = [];
  for (const c of COLORS) {
    d.push({color:c, value:'0'});
    for (let i = 0; i < 2; i++) for (const v of VALS.slice(1)) d.push({color:c, value:v});
  }
  for (let i = 0; i < 4; i++) { d.push({color:'wild',value:'wild'}); d.push({color:'wild',value:'wild4'}); }
  return d;
}
function shuf(a) { for (let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]];} return a; }
function escHtml(s) { const d=document.createElement('div'); d.textContent=s; return d.innerHTML; }

function startGame() {
  document.getElementById('goModal').classList.remove('open');
  const nm = (document.getElementById('inpName').value.trim()) || '@PuffMaster';
  const nOpp = parseInt(document.getElementById('selOpps').value);
  const diff = document.getElementById('selDiff').value;

  const bots = shuf([...STONERS]);
  const players = [{name: nm, isHuman: true, hand: [], calledUno: false, avatar: 'üßë‚Äçüé§'}];
  for (let i = 0; i < nOpp; i++) players.push({name: bots[i].name, isHuman: false, hand: [], calledUno: false, avatar: bots[i].avatar});

  const deck = shuf(makeDeck());
  for (const p of players) for (let i = 0; i < 7; i++) p.hand.push(deck.pop());

  let start;
  while (true) {
    start = deck.pop();
    if (start.color !== 'wild' && !['skip','reverse','draw2'].includes(start.value)) break;
    deck.unshift(start); shuf(deck);
  }

  game = { players, deck, discard: [start], cur: 0, dir: 1, color: start.color, difficulty: diff, drawn: false, pendingWild: null, over: false, eventMsg: '' };

  goScreen('game');
  render();
  addChatMsg('System', 'üî• The sesh has begun! Light it up!');
  if (game.cur !== 0) maybeBot();
}

// ===== ROOM SYSTEM =====
let room = null;
function genCode() { const ch='ABCDEFGHJKLMNPQRSTUVWXYZ23456789'; let c=''; for(let i=0;i<6;i++) c+=ch[Math.floor(Math.random()*ch.length)]; return c; }
function createRoom() {
  const host = document.getElementById('inpHost').value.trim() || '@Host420';
  const rName = document.getElementById('inpRoomName').value.trim() || 'Chill Den üçÉ';
  const maxP = parseInt(document.getElementById('selMaxP').value);
  room = { code: genCode(), name: rName, maxP, players: [{name: host, isHost: true}] };
  showLobby(); goScreen('lobby');
  toast('Room created! Share the code üçÉ');
}
function showLobby() {
  if (!room) return;
  document.getElementById('lobbyTitle').textContent = 'üçÉ ' + room.name;
  document.getElementById('lobbyCode').textContent = room.code;
  const list = document.getElementById('lobbyList');
  list.innerHTML = '';
  room.players.forEach(p => {
    const li = document.createElement('li');
    li.className = p.isHost ? 'host' : '';
    li.innerHTML = '<span class="p-avatar">' + (p.isHost ? 'üëë' : 'üçÉ') + '</span>' +
      '<span>' + escHtml(p.name) + '</span>' +
      (p.isHost ? '<span style="margin-left:auto;font-size:10px;color:var(--neon-gold);font-weight:800;">HOST</span>' : '');
    list.appendChild(li);
  });
  for (let i = room.players.length; i < room.maxP; i++) {
    const li = document.createElement('li');
    li.style.opacity = '0.35';
    li.innerHTML = '<span class="p-avatar">‚è≥</span><span>Waiting...</span>';
    list.appendChild(li);
  }
}
function copyCode() {
  if (!room) return;
  const fb = document.getElementById('copyMsg');
  if (navigator.clipboard && navigator.clipboard.writeText) {
    navigator.clipboard.writeText(room.code).then(() => { fb.textContent = '‚úÖ Copied!'; setTimeout(() => { fb.textContent = ''; }, 2000); });
  } else { fb.textContent = room.code; }
}
function shareInvite() {
  if (!room) return;
  const txt = 'üçÉüí® Join my 420 UNO sesh!\nRoom: ' + room.name + '\nCode: ' + room.code + '\nPuff puff pass the cards! üÉèüî•';
  if (navigator.clipboard && navigator.clipboard.writeText) {
    navigator.clipboard.writeText(txt).then(() => toast('Invite copied! üìã'));
  } else { toast('Code: ' + room.code); }
}
function joinRoom() {
  const nm = document.getElementById('inpJoinName').value.trim() || '@ChillVibes';
  const code = document.getElementById('inpJoinCode').value.trim().toUpperCase();
  if (code.length < 4) { toast('Enter a valid code ü§®'); return; }
  room = { code, name: 'Sesh Room üçÉ', maxP: 4, players: [{name:'@Host420', isHost:true}, {name: nm, isHost: false}] };
  setTimeout(() => {
    if (room && room.code === code) {
      const ex = shuf([...STONERS]);
      room.players.push({name: ex[0].name, isHost: false});
      showLobby(); toast(ex[0].name + ' joined! üçÉ');
    }
  }, 2500);
  showLobby(); goScreen('lobby'); toast('Joined the sesh! üí®');
}
function launchRoomGame() {
  const host = room ? room.players[0].name : '@Host420';
  document.getElementById('inpName').value = host;
  const opp = room ? Math.min(room.maxP - 1, 3) : 2;
  document.getElementById('selOpps').value = opp.toString();
  document.getElementById('selDiff').value = 'medium';
  startGame();
}

// ===== RENDERING =====
function getCardClass(c) { return c.color === 'wild' ? 'c-wild' : 'c-' + c.color; }
function getCardLabel(c) { return CARD_LABELS[c.value] || c.value; }
function getCardMotif(c) { return CARD_MOTIFS[c.value] || ''; }

function canPlay(c) {
  if (!game || game.cur !== 0 || game.over) return false;
  if (c.color === 'wild') return true;
  return c.color === game.color || c.value === game.discard[game.discard.length-1].value;
}

function buildCard(card, playable, onclick) {
  const div = document.createElement('div');
  const label = getCardLabel(card);
  const motif = getCardMotif(card);
  div.className = 'uno-card ' + getCardClass(card) + (playable ? ' playable' : ' dimmed');
  div.innerHTML =
    '<span class="corner corner-tl">' + label.replace('\n',' ') + '</span>' +
    '<span class="card-val">' + label.replace('\n','<br>') + '</span>' +
    (motif ? '<span class="card-motif">' + motif + '</span>' : '') +
    '<span class="corner corner-br">' + label.replace('\n',' ') + '</span>';
  if (onclick) div.addEventListener('click', onclick);
  return div;
}

function render() {
  if (!game) return;
  // HUD
  const cp = game.players[game.cur];
  document.getElementById('hudTurn').textContent = cp.isHuman ? 'üî• Your Turn' : 'üí® ' + cp.name;
  const colorMap = {red:'#ff2a2a',blue:'#2a7aff',green:'#2aff5a',yellow:'#ffe02a'};
  const orb = document.getElementById('hudOrb');
  orb.style.background = colorMap[game.color] || '#888';
  orb.style.color = colorMap[game.color] || '#888';
  document.getElementById('hudColorName').textContent = game.color;
  document.getElementById('hudDir').classList.toggle('rev', game.dir === -1);

  // Opponents
  const row = document.getElementById('oppRow');
  row.innerHTML = '';
  for (let i = 1; i < game.players.length; i++) {
    const p = game.players[i];
    const d = document.createElement('div');
    d.className = 'opp-card' + (game.cur === i ? ' active' : '');
    let handIcons = '';
    for (let c = 0; c < Math.min(p.hand.length, 8); c++) handIcons += 'üÇ†';
    if (p.hand.length > 8) handIcons += '‚Ä¶';
    d.innerHTML =
      '<div class="opp-avatar">' + p.avatar + '</div>' +
      '<div class="opp-name">' + escHtml(p.name) + '</div>' +
      '<div class="opp-hand-display">' + handIcons + '</div>' +
      '<div class="opp-count">' + p.hand.length + ' cards</div>' +
      (p.hand.length === 1 ? '<div class="opp-uno-badge">UNO!</div>' : '');
    row.appendChild(d);
  }

  // Event
  document.getElementById('eventMsg').textContent = game.eventMsg || '';

  // Discard
  const dp = document.getElementById('discardPile');
  dp.innerHTML = '';
  const top = game.discard[game.discard.length-1];
  const topEl = buildCard(top, false);
  topEl.style.cursor = 'default';
  topEl.classList.remove('dimmed');
  dp.appendChild(topEl);
  dp.innerHTML += '<span class="pile-tag">DISCARD</span>';

  // Hand
  const hs = document.getElementById('handScroll');
  hs.innerHTML = '';
  const hand = game.players[0].hand;
  const myTurn = game.cur === 0;
  hand.forEach((c, i) => {
    const ok = myTurn && canPlay(c);
    const el = buildCard(c, ok, ok ? () => playCard(i) : null);
    el.classList.add('dealt');
    el.style.animationDelay = (i * 0.025) + 's';
    hs.appendChild(el);
  });
  document.getElementById('handCount').textContent = '(' + hand.length + ')';
  document.getElementById('passBtn').style.display = (myTurn && game.drawn) ? '' : 'none';

  // UNO fab
  const fab = document.getElementById('unoFab');
  fab.classList.toggle('show', hand.length === 2 && myTurn && !game.players[0].calledUno);
}

// ===== GAME LOGIC =====
function drawFromDeck() {
  if (game.deck.length === 0) {
    const top = game.discard.pop();
    game.deck = shuf(game.discard.map(c => (c.color === 'wild' || c.value === 'wild' || c.value === 'wild4') ? {color:'wild',value:c.value} : c));
    game.discard = [top];
  }
  return game.deck.pop();
}
function nextP() { game.cur = (game.cur + game.dir + game.players.length) % game.players.length; }

function playCard(idx) {
  if (!game || game.over || game.cur !== 0) return;
  const hand = game.players[0].hand;
  const card = hand[idx];
  if (!canPlay(card)) return;

  if (hand.length === 2 && !game.players[0].calledUno) {
    toast('Forgot UNO call! Draw 2 penalty üò§');
    for (let i = 0; i < 2; i++) hand.push(drawFromDeck());
  }
  hand.splice(idx, 1);
  game.players[0].calledUno = false;

  if (card.color === 'wild') {
    game.pendingWild = card;
    document.getElementById('colorModal').classList.add('open');
    render();
    return;
  }
  execCard(card, 0);
}
function pickColor(color) {
  document.getElementById('colorModal').classList.remove('open');
  if (!game || !game.pendingWild) return;
  const c = game.pendingWild;
  game.pendingWild = null;
  execCard({color, value: c.value}, 0);
}
function execCard(card, pi) {
  game.discard.push(card);
  game.color = card.color === 'wild' ? card.color : card.color;
  if (card.color !== 'wild') game.color = card.color;
  // wild color already set if chosen
  if (['red','blue','green','yellow'].includes(card.color)) game.color = card.color;
  game.eventMsg = '';
  game.drawn = false;

  if (game.players[pi].hand.length === 0) {
    game.over = true;
    render();
    setTimeout(() => showWin(pi), 700);
    return;
  }

  if (card.value === 'skip') {
    nextP();
    const sk = game.players[game.cur];
    game.eventMsg = sk.name + ' skipped! üö´ Puff & Pass!';
    toast(game.eventMsg);
    nextP();
  } else if (card.value === 'reverse') {
    if (game.players.length === 2) { nextP(); game.eventMsg = 'Boomerang Joint! üîÑüí®'; }
    else { game.dir *= -1; game.eventMsg = 'Reversed! üîÑüí®'; }
    nextP();
  } else if (card.value === 'draw2') {
    nextP();
    const v = game.players[game.cur];
    for (let i = 0; i < 2; i++) v.hand.push(drawFromDeck());
    game.eventMsg = v.name + ' draws 2 pre-rolls! üö¨üö¨';
    toast(game.eventMsg);
    nextP();
  } else if (card.value === 'wild4') {
    nextP();
    const v = game.players[game.cur];
    for (let i = 0; i < 4; i++) v.hand.push(drawFromDeck());
    game.eventMsg = v.name + ' takes a BLAZE +4 hit! üå¨Ô∏èüî•';
    toast(game.eventMsg);
    nextP();
  } else {
    nextP();
  }

  render();
  setTimeout(() => maybeBot(), 800);
}

function drawCard() {
  if (!game || game.over || game.cur !== 0 || game.drawn) return;
  const c = drawFromDeck();
  game.players[0].hand.push(c);
  game.drawn = true;
  toast('Drew a card üçÉ');
  render();
}
function passTurn() {
  if (!game || game.cur !== 0 || !game.drawn) return;
  game.drawn = false;
  game.eventMsg = '';
  nextP();
  render();
  setTimeout(() => maybeBot(), 600);
}
function callUno() {
  if (!game || game.cur !== 0) return;
  game.players[0].calledUno = true;
  toast('üçÉ UNO CALLED! üçÉ');
  document.getElementById('unoFab').classList.remove('show');
}

// ===== BOT AI =====
function maybeBot() {
  if (!game || game.over || game.players[game.cur].isHuman) return;
  setTimeout(() => botTurn(), 600 + Math.random() * 900);
}
function botTurn() {
  if (!game || game.over) return;
  const pi = game.cur;
  const p = game.players[pi];
  if (p.isHuman) return;
  const hand = p.hand;
  const top = game.discard[game.discard.length-1];

  let plays = [];
  hand.forEach((c,i) => {
    if (c.color === 'wild' || c.color === game.color || c.value === top.value) plays.push({card:c, idx:i});
  });

  if (hand.length === 2 && Math.random() > 0.15) { p.calledUno = true; toast(p.name + ' calls UNO! üçÉüî•'); }

  if (plays.length > 0) {
    let pick;
    if (game.difficulty === 'hard') {
      plays.sort((a,b) => {
        const sc = c => { if(c.value==='wild4')return 10; if(c.value==='draw2')return 8; if(c.value==='skip')return 7; if(c.value==='reverse')return 6; if(c.value==='wild')return 5; return parseInt(c.value)||0; };
        return sc(b.card) - sc(a.card);
      });
      pick = plays[0];
    } else if (game.difficulty === 'medium') {
      const nw = plays.filter(p => p.card.color !== 'wild');
      pick = nw.length > 0 ? nw[Math.floor(Math.random() * nw.length)] : plays[0];
    } else {
      pick = plays[Math.floor(Math.random() * plays.length)];
    }
    hand.splice(pick.idx, 1);
    const card = pick.card;
    if (card.color === 'wild') {
      const cc = {red:0,blue:0,green:0,yellow:0};
      hand.forEach(c => { if(cc[c.color] !== undefined) cc[c.color]++; });
      let best = 'green', bv = -1;
      for (const cl of COLORS) { if(cc[cl]>bv){bv=cc[cl];best=cl;} }
      game.color = best;
      toast(p.name + ' plays ' + getCardLabel(card) + ' ‚Üí ' + best + '!');
      execCard({color: best, value: card.value}, pi);
    } else {
      toast(p.name + ' plays ' + getCardLabel(card));
      execCard(card, pi);
    }
  } else {
    const drawn = drawFromDeck();
    hand.push(drawn);
    toast(p.name + ' draws üí®');
    if (drawn.color === 'wild' || drawn.color === game.color || drawn.value === top.value) {
      setTimeout(() => {
        if (game.over) return;
        const di = hand.indexOf(drawn);
        if (di === -1) return;
        hand.splice(di, 1);
        if (drawn.color === 'wild') {
          const cc = {red:0,blue:0,green:0,yellow:0};
          hand.forEach(c => { if(cc[c.color]!==undefined) cc[c.color]++; });
          let best='green',bv=-1;
          for(const cl of COLORS){if(cc[cl]>bv){bv=cc[cl];best=cl;}}
          game.color = best;
          execCard({color:best,value:drawn.value}, pi);
        } else { execCard(drawn, pi); }
      }, 600);
    } else {
      game.eventMsg = '';
      nextP(); render();
      setTimeout(() => maybeBot(), 600);
    }
  }
}

function showWin(pi) {
  const p = game.players[pi];
  document.getElementById('goTitle').textContent = p.isHuman ? 'YOU WIN! üèÜ' : p.name + ' Wins!';
  document.getElementById('goSub').textContent = p.isHuman
    ? 'Absolutely blazed through the competition üçÉüí®üî•'
    : 'They smoked everyone! Better luck next sesh üåø';
  document.getElementById('goModal').classList.add('open');
}
</script>
</body>
</html>
